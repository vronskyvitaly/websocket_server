# Express WebSocket Chat Server

Express —Å–µ—Ä–≤–µ—Ä —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π WebSocket –∏ Socket.IO –¥–ª—è —á–∞—Ç–∞ —Å PostgreSQL –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö (Neon).

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

1. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**

   ```bash
   pnpm install
   cd client && npm install
   ```

2. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö:**

   –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –ø–∞–ø–∫–µ `server` (—Å–º. `ENV_SETUP.md`):

   ```env
   DATABASE_URL="postgresql://username:password@host:port/database?sslmode=require"
   DIRECT_URL="postgresql://username:password@host:port/database?sslmode=require"
   ```

3. **–°–æ–∑–¥–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:**

   ```bash
   pnpm run db:generate
   pnpm run db:push
   ```

4. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä:**

   ```bash
   pnpm run dev
   ```

5. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç:**

   ```bash
   cd client
   npm run dev
   ```

6. **–û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä:**
   - –ö–ª–∏–µ–Ω—Ç: http://localhost:3000
   - –°–µ—Ä–≤–µ—Ä: http://localhost:3002

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. WebSocket –∫–æ–Ω—Ñ–ª–∏–∫—Ç

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–Ω—Ñ–ª–∏–∫—Ç –º–µ–∂–¥—É Socket.IO –∏ –Ω–∞—Ç–∏–≤–Ω—ã–º WebSocket —Å–µ—Ä–≤–µ—Ä–æ–º –≤—ã–∑—ã–≤–∞–ª –æ—à–∏–±–∫—É `Invalid WebSocket frame: invalid status code 59469`.

**–†–µ—à–µ–Ω–∏–µ:** –£–¥–∞–ª–µ–Ω –Ω–∞—Ç–∏–≤–Ω—ã–π WebSocket —Å–µ—Ä–≤–µ—Ä, –æ—Å—Ç–∞–≤–ª–µ–Ω —Ç–æ–ª—å–∫–æ Socket.IO.

### 2. FOREIGN KEY constraint failed

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞ –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∫–æ–º–Ω–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.

**–†–µ—à–µ–Ω–∏–µ:**

- –î–æ–±–∞–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–∑–æ–≤ `createDefaultRoom()` –≤ `createChatUser()`
- –£–ª—É—á—à–µ–Ω –º–µ—Ç–æ–¥ `createDefaultRoom()` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∫–æ–º–Ω–∞—Ç—ã
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### 3. CORS –ø—Ä–æ–±–ª–µ–º—ã

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ–±–ª–µ–º—ã —Å CORS –ø—Ä–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏ –Ω–∞ Vercel.

**–†–µ—à–µ–Ω–∏–µ:** –£–ª—É—á—à–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è CORS –≤ Socket.IO —Å–µ—Ä–≤–µ—Ä–µ.

## üåê –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ Vercel

### –°–µ—Ä–≤–µ—Ä (Backend)

1. **–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç –Ω–∞ Vercel**
2. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**

   ```
   PORT=3002
   CORS_ORIGIN=https://your-frontend-domain.vercel.app
   NODE_ENV=production
   ```

3. **–î–æ–±–∞–≤—å—Ç–µ build –∫–æ–º–∞–Ω–¥—É:**
   ```json
   {
     "buildCommand": "npm run build",
     "outputDirectory": "dist",
     "installCommand": "npm install"
   }
   ```

### –ö–ª–∏–µ–Ω—Ç (Frontend)

1. **–°–æ–∑–¥–∞–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç –Ω–∞ Vercel**
2. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**

   ```
   NEXT_PUBLIC_SOCKETIO_URL=https://your-backend-domain.vercel.app
   ```

3. **–û–±–Ω–æ–≤–∏—Ç–µ vercel.json:**
   ```json
   {
     "buildCommand": "npm run build",
     "outputDirectory": ".next",
     "framework": "nextjs",
     "installCommand": "npm install",
     "devCommand": "npm run dev"
   }
   ```

## üìä API Endpoints

### Health Check

- `GET /health` - –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏

- `GET /api/users` - –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –°–æ–æ–±—â–µ–Ω–∏—è

- `GET /api/messages` - –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
- `GET /api/chat/messages` - –°–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞
- `GET /api/chat/users/:userId/messages` - –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## üîå Socket.IO Events

### –ö–ª–∏–µ–Ω—Ç ‚Üí –°–µ—Ä–≤–µ—Ä

- `setUsername` - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `sendMessage` - –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
- `joinRoom` - –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ
- `leaveRoom` - –ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É
- `typing` - –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
- `requestHistory` - –ó–∞–ø—Ä–æ—Å–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π

### –°–µ—Ä–≤–µ—Ä ‚Üí –ö–ª–∏–µ–Ω—Ç

- `connected` - –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
- `message` - –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- `messageHistory` - –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
- `userJoined` - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è
- `userLeft` - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç
- `roomUsers` - –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –∫–æ–º–Ω–∞—Ç–µ
- `userTyping` - –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `error` - –û—à–∏–±–∫–∞

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

PostgreSQL –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (Neon) —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏:

- `messages` - –°–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã messages:

- `id` (Int, Primary Key, Auto Increment)
- `content` (String, NOT NULL)
- `userId` (String, Optional)
- `timestamp` (DateTime, Default: now())

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö:

```bash
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma –∫–ª–∏–µ–Ω—Ç–∞
pnpm run db:generate

# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å—Ö–µ–º—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
pnpm run db:push

# –°–æ–∑–¥–∞–Ω–∏–µ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
pnpm run db:migrate

# –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö –≤ –±—Ä–∞—É–∑–µ—Ä–µ
pnpm run db:studio
```

## üõ†Ô∏è –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts              # –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä
‚îÇ   ‚îú‚îÄ‚îÄ socketio.ts           # Socket.IO –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
‚îÇ   ‚îú‚îÄ‚îÄ database.ts           # REST API —Ä–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ database-service.ts   # Socket.IO —Ä–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ prisma.ts             # Prisma –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îî‚îÄ‚îÄ types.ts              # TypeScript —Ç–∏–ø—ã
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îî‚îÄ‚îÄ schema.prisma         # –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ client/
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app/              # Next.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hooks/            # React —Ö—É–∫–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ types/            # –¢–∏–ø—ã –∫–ª–∏–µ–Ω—Ç–∞
‚îÇ   ‚îî‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ .env                      # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```

### –ö–æ–º–∞–Ω–¥—ã

```bash
# –°–±–æ—Ä–∫–∞
pnpm run build

# –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞
pnpm run dev

# –û—á–∏—Å—Ç–∫–∞
pnpm run clean

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
pnpm run db:generate    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma –∫–ª–∏–µ–Ω—Ç–∞
pnpm run db:push        # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å—Ö–µ–º—ã
pnpm run db:migrate     # –ú–∏–≥—Ä–∞—Ü–∏–∏
pnpm run db:studio      # –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö
```

## üîç –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞

```bash
curl http://localhost:3002/health
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
# –û—Ç–∫—Ä—ã—Ç—å Prisma Studio
pnpm run db:studio

# –ò–ª–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
pnpm run db:push
```

### –õ–æ–≥–∏

–°–µ—Ä–≤–µ—Ä –≤—ã–≤–æ–¥–∏—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ —Å —ç–º–æ–¥–∑–∏ –¥–ª—è –ª–µ–≥–∫–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:

- üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
- üí¨ –°–æ–æ–±—â–µ–Ω–∏—è
- ‚ùå –û—à–∏–±–∫–∏

## üìù –õ–∏—Ü–µ–Ω–∑–∏—è

MIT
